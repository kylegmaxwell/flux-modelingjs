{
    "$schema": "http://json-schema.org/draft-04/schema#",
    "scene": {
        "type": "object",
        "properties": {
            "primitive":    {"enum" : ["scene"]},
            "version":      {"type": "string"},
            "elements":     { "$ref": "#/scene/elements"   }
        },
        "required": [ "elements", "version", "primitive" ],
        "additionalProperties": false,
        "elements": {
            "type": "array",
            "items": { "$ref": "#/scene/element" },
            "additionalItems":  false
        },
        "entity": {
            "anyOf": [
                { "$ref": "#/entities/empty"  },
                { "$ref": "#/entities/number" },
                { "$ref": "#/entities/brep"   },
                { "$ref": "#/entities/vector" },
                { "$ref": "#/entities/point" },
                { "$ref": "#/entities/plane" },

                { "$ref": "#/entities/affineTransform" },
                { "$ref": "#/entities/massProps" },

                { "$ref": "#/entities/line" },
                { "$ref": "#/entities/polyline" },
                { "$ref": "#/entities/circle" },
                { "$ref": "#/entities/ellipse" },
                { "$ref": "#/entities/curve" },
                { "$ref": "#/entities/arc" },
                { "$ref": "#/entities/rectangle" },
                { "$ref": "#/entities/polycurve" },

                { "$ref": "#/entities/polygonSet" },
                { "$ref": "#/entities/surface" },
                { "$ref": "#/entities/polysurface" },

                { "$ref": "#/entities/block" },
                { "$ref": "#/entities/torus" },
                { "$ref": "#/entities/sphere" },
                { "$ref": "#/entities/cylinder" },
                { "$ref": "#/entities/cone" },
                { "$ref": "#/entities/mesh" }
            ]
        },
        "element": {
            "anyOf": [
                { "$ref": "#/scene/entity"  },

                { "$ref": "#/assembly" },
                { "$ref": "#/instance" },
                { "$ref": "#/alphaGeometryContainer" },
                { "$ref": "#/layer" }
            ]
        }
    },
    "types": {
        "brep_format": { "enum": [ "x_b", "x_t", "iges", "step", "sat", "sab", "stl" ] },

        "index": {
            "type":    "integer",
            "minimum": 0
        },
        "indexNonzero": {
            "type":    "integer",
            "minimum": 0,
            "exclusiveMinimum": true
        },
        "direction": {
            "type": "array",
            "items": { "type": "number" },
            "minItems": 3,
            "maxItems": 3
        },
        "fluxid": {
            "type": "string"
        },
        "angle": {
            "type": "number",
            "fluxDimension": "angle"
        },
        "coordinate": {
            "type": "number",
            "fluxDimension": "length"
        },
        "distance": {
            "type":     "number",
            "minimum":  0,
            "fluxDimension": "length"
        },
        "area": {
            "type": "number",
            "minimum": 0,
            "fluxDimension": "area"
        },
        "volume": {
            "type": "number",
            "minimum": 0,
            "fluxDimension": "volume"
        },
        "distanceNonzero": {
            "type":     "number",
            "minimum":  0,
            "exclusiveMinimum": true,
            "fluxDimension": "length"
        },
        "position": {
            "type": "array",
            "items": { "$ref": "#/types/coordinate" },
            "minItems": 3,
            "maxItems": 3
        },
        "dimensions": {
            "type": "array",
            "items": { "$ref": "#/types/distanceNonzero" },
            "minItems": 3,
            "maxItems": 3
        },
        "units": {
            "type": "object",
            "additionalProperties": false,
            "patternProperties": {
                ".*" : {"type": "string" }
            }
        },
        "boundingBox":{
            "type": "array",
            "items":{ "$ref": "#/types/position" },
            "minItems": 2,
            "maxItems": 2
        },
        "matrix":{
            "type": "array",
            "items": { "type": "number" },
            "minItems": 16,
            "maxItems": 16
        },
        "color":{
            "anyOf": [
                {
                    "type": "array",
                    "items": {"$ref": "#/types/indexNonzero"},
                    "minItems": 3,
                    "maxItems": 3
                },
                {"type": "string" }
            ]
        }
    },
    "entities": {
        "empty": { "type": "object", "additionalProperties": false },
        "number": { "type": "number" },

        "brep": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "brep" ] },
                "content":      { "type": "string"   },
                "format":       { "$ref": "#/types/brep_format" },
                "isCompressed": { "type": "boolean" },
                "isBase64":     { "type": "boolean" },
                "vertices":     {
                    "type":     "array",
                    "items":    { "$ref": "#/types/position" }
                },
                "faces":        {
                    "type":     "array",
                    "items":    {
                        "type":     "array",
                        "items":    { "$ref": "#/types/index" },
                        "minItems": 3
                    }
                },
                "attributes":   {}
            },
            "required": [ "primitive", "content", "format" ]
        },

        "vector": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "vector" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "coords":       { "$ref": "#/types/position" }
            },
            "required": [ "primitive", "coords" ]
        },
        "point": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "point" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "point":       { "$ref": "#/types/position" }
            },
            "required": [ "primitive", "point" ]
        },

        "plane": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "plane" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position"  },
                "normal":       { "$ref": "#/types/direction" }
            },
            "required": [ "primitive", "origin", "normal" ]
        },
        "affineTransform": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "affineTransform" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "mat":          {
                    "type": "array",
                    "items": { "type": "number" },
                    "minItems": 16,
                    "maxItems": 16,
                    "fluxDimension": "affineMatrix"
                }
            },
            "required": [ "primitive", "mat" ],
            "additionalProperties": false
        },
        "massProps": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "massProps" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "mass":         { "$ref": "#/types/distance" },
                "centerOfMass": { "$ref": "#/types/position" },
                "inertiaTensor":{
                    "type": "array",
                    "items": { "$ref": "#/types/direction" },
                    "minItems": 3,
                    "maxItems": 3
                },

                "volume":       { "$ref": "#/types/volume"   },
                "surfaceArea":  { "$ref": "#/types/area"     },
                "length":       { "$ref": "#/types/distance" },
                "circumference":{ "$ref": "#/types/distance" }
            },
            "required": [ "primitive", "mass", "centerOfMass", "inertiaTensor" ],
            "additionalProperties": false
        },

        "line": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "line" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "start":        { "$ref": "#/types/position" },
                "end":          { "$ref": "#/types/position" }
            },
            "required": [ "primitive", "start", "end" ]
        },
        "polyline": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "polyline" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "points":       {
                    "type": "array",
                    "items": { "$ref": "#/types/position" },
                    "minItems": 2
                }
            },
            "required": [ "primitive", "points" ]
        },
        "circle": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "circle" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position" },
                "radius":       { "$ref": "#/types/distanceNonzero" },
                "axis":         { "$ref": "#/types/direction" }
            },
            "required": [ "primitive", "origin", "radius" ]
        },
        "ellipse": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "ellipse" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position" },
                "majorRadius":  { "$ref": "#/types/distanceNonzero" },
                "minorRadius":  { "$ref": "#/types/distanceNonzero" },
                "axis":         { "$ref": "#/types/direction" },
                "reference":    { "$ref": "#/types/direction" }
            },
            "required": [ "primitive", "origin", "majorRadius", "minorRadius" ]
        },
        "curve": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "curve" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "degree":       { "$ref": "#/types/indexNonzero" },
                "controlPoints":{ "type": "array", "items": { "$ref": "#/types/position" }},
                "knots":        { "type": "array", "items": { "type": "number" }},
                "weights":      { "type": "array", "items": { "type": "number" }}
            },
            "required": [ "primitive", "degree", "controlPoints", "knots" ]
        },
        "arc": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "arc" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "start":        { "$ref": "#/types/position" },
                "middle":       { "$ref": "#/types/position" },
                "end":          { "$ref": "#/types/position" }
            },
            "required": [ "primitive", "start", "middle", "end" ]
        },
        "rectangle": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "rectangle" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position" },
                "dimensions":   {
                    "type": "array",
                    "items": { "$ref": "#/types/distanceNonzero" },
                    "minItems": 2,
                    "maxItems": 2,
                    "additionalItems": false
                },
                "axis":         { "$ref": "#/types/direction" },
                "reference":    { "$ref": "#/types/direction" }
            },
            "required": [ "primitive", "origin", "dimensions" ]
        },
        "polycurve": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "polycurve" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},

                "curves":       {
                    "type":  "array",
                    "minItems": 1,
                    "items": { "oneOf": [
                        { "$ref": "#/entities/line" },
                        { "$ref": "#/entities/polyline" },
                        { "$ref": "#/entities/curve" },
                        { "$ref": "#/entities/arc" }
                    ] }
                }
            },
            "required": [ "primitive", "curves" ]
        },

        "polygonSet": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "polygonSet" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "polygons":     {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "boundary": { "$ref" : "#/entities/polygonSet/polygon" },
                            "holes":    {
                                "type": "array",
                                "items": { "$ref" : "#/entities/polygonSet/polygon" }
                            }
                        },
                        "required": [ "boundary", "holes" ],
                        "additionalProperties": false
                    },
                    "minItems": 1
                }
            },
            "required": [ "primitive", "polygons" ],
            "polygon": {
                "type": "array",
                "items": { "$ref": "#/types/position" },
                "minItems": 3
            }
        },
        "surface": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "surface" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "uDegree":      { "$ref": "#/types/indexNonzero" },
                "vDegree":      { "$ref": "#/types/indexNonzero" },
                "uKnots":       { "type": "array", "items": { "type": "number" }},
                "vKnots":       { "type": "array", "items": { "type": "number" }},
                "controlPoints":{
                    "type": "array",
                    "items": {
                        "type": "array",
                        "items": {
                            "$ref": "#/types/position"
                        }
                    }
                },
                "weights":      { "type": "array", "items": { "type": "number" }}
            },
            "required": [ "primitive", "uDegree", "vDegree", "uKnots", "vKnots", "controlPoints" ]
        },
        "polysurface": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "polysurface" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},

                "surfaces": {
                    "type": "array",
                    "items": { "oneOf": [
                        { "$ref": "#/entities/polygonSet" },
                        { "$ref": "#/entities/surface" }
                    ]},
                    "minItems": 1
                }
            },
            "required": [ "primitive", "surfaces" ]
        },

        "block": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "block" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position" },
                "dimensions":   { "$ref": "#/types/dimensions" },
                "axis":         { "$ref": "#/types/direction" },
                "reference":    { "$ref": "#/types/direction" }
            },
            "required": [ "primitive", "origin", "dimensions" ]
        },
        "torus": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "torus" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position" },
                "majorRadius":  { "$ref": "#/types/coordinate" },
                "minorRadius":  { "$ref": "#/types/distanceNonzero" },
                "axis":         { "$ref": "#/types/direction" }
            },
            "required": [ "primitive", "origin", "majorRadius", "minorRadius" ]
        },
        "sphere": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "sphere" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position" },
                "radius":       { "$ref": "#/types/distanceNonzero" }
            },
            "required": [ "primitive", "origin", "radius" ]
        },
        "cylinder": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "cylinder" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position" },
                "radius":       { "$ref": "#/types/distanceNonzero" },
                "height":       { "$ref": "#/types/distanceNonzero" },
                "axis":         { "$ref": "#/types/direction" }
            },
            "required": [ "primitive", "origin", "radius", "height" ]
        },
        "cone": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "cone" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "origin":       { "$ref": "#/types/position" },
                "radius":       { "$ref": "#/types/distanceNonzero" },
                "height":       { "$ref": "#/types/distanceNonzero" },
                "semiAngle":    { "$ref": "#/types/angle" },
                "axis":         { "$ref": "#/types/direction" }
            },
            "required": [ "primitive", "origin", "radius", "height", "semiAngle" ]
        },
        "mesh": {
            "type": "object",
            "properties": {
                "primitive":    { "enum": [ "mesh" ] },
                "__repr__":     { "type": "string" },
                "attributes":   {},
                "units":        { "$ref": "#/types/units" },

                "vertices":     {
                    "type":     "array",
                    "items":    { "$ref": "#/types/position" }
                },
                "faces":        {
                    "type":     "array",
                    "items":    {
                        "type":     "array",
                        "items":    { "$ref": "#/types/index" },
                        "minItems": 3
                    }
                },
                "isSolid": { "type": "boolean" }
            },
            "required": [ "primitive", "vertices", "faces" ]
        }
    },
    "instance": {
            "type": "object",
            "properties": {
                "attributes":   {},
                "primitive":    { "enum": [ "instance" ] },
                "id":           { "$ref": "#/types/fluxid" },
                "matrix":       { "$ref": "#/types/matrix" },
                "bbox":         { "$ref": "#/types/boundingBox" },
                "label":        { "type": "string" },
                "entity":       { "$ref": "#/types/fluxid" }
            },
                "required": [ "primitive", "id", "entity" ],
                "additionalProperties": false
        },
    "alphaGeometryContainer": {
            "type": "object",
            "properties": {
                "attributes":   {},
                "primitive":    { "enum": [ "alphaGeometryContainer" ] },
                "id":           { "$ref": "#/types/fluxid" },
                "entity": {
                    "anyOf": [
                        { "type": "array"  },
                        { "type": "object" }
                    ]
                },
                "required": [ "primitive", "id", "entity" ],
                "additionalProperties": false
            }
        },
    "assembly": {
        "type": "object",
        "properties": {
            "attributes":   {},
            "primitive":    { "enum":[ "assembly" ] },
            "id":           { "$ref": "#/types/fluxid" },
            "matrix":       { "$ref": "#/types/matrix" },
            "bbox":         { "$ref": "#/types/boundingBox" },
            "label":        { "type": "string" },
            "children":     {
                "type":     "array",
                "items":    { "$ref": "#/types/fluxid" }
            }
        },
        "required": [ "primitive", "id", "children" ],
        "additionalProperties": true
    },
    "layer": {
        "type": "object",
        "properties": {
            "attributes":   {},
            "primitive":    { "enum":[ "layer" ] },
            "id":           { "$ref": "#/types/fluxid" },
            "label":            { "type": "string" },
            "color":            { "$ref": "#/types/color" },
            "visible":      { "type": "boolean" },
            "elements": {
                "type":     "array",
                "items":    { "$ref": "#/types/fluxid" }
            }
        },
        "required": [ "primitive", "id", "elements" ],
        "additionalProperties": false
    }
}
